name: ğŸ§¹ Preview Cleanup

on:
  pull_request:
    types: [closed]

jobs:
  destroy:
    name: ğŸ—‘ Remove Preview App
    runs-on: ubuntu-24.04
    if: ${{ github.event.pull_request.head.repo.fork == false }}

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ”¤ Read Fly app name
        id: base_app
        uses: SebRollen/toml-action@v1.2.0
        with:
          file: fly.toml
          field: app

      - name: ğŸˆ Setup Fly
        uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: ğŸ—‘ Destroy preview app
        shell: bash
        run: |
          set -euo pipefail
          preview_app_name="${{ steps.base_app.outputs.value }}-pr-${{ github.event.pull_request.number }}"

          flyctl apps destroy "${preview_app_name}" --yes || echo "App already removed"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: ğŸ’¬ Notify pull request
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            â™»ï¸ Preview environment `${{ steps.base_app.outputs.value }}-pr-${{ github.event.pull_request.number }}` has been destroyed.
